---
- name: "Ensure required parameter(s) are provided."
  ansible.builtin.assert:
    that:
      - wildfly_home is defined
      - wildfly_prospero_home is defined
      - wildfly_prospero_repos_urls is defined
    quiet: True
      #todo install prospero on target

- name: "Ensure Prospero is properly installed on target."
  ansible.builtin.unarchive:
    src: "{{ wildfly_prospero_download_url }}"
    dest: "{{ wildfly_prospero_install_dir }}"
    owner: "{{ wildfly_install_user | default(omit) }}"
    group: "{{ wildfly_install_group | default(omit) }}"
    remote_src: yes

- name: "Run Proposero to install server in {{ wildfly_home }}."
  ansible.builtin.command: >
    {{ wildfly_prospero_home }}/bin/prospero.sh install --dir {{ wildfly_home }} --fpl wildfly --repositories={{ wildfly_prospero_repos_urls }}
  register: prospero_run_results
  changed_when: not prospero_run_results.rc == 2
  failed_when: prospero_run_results.rc == 1 or prospero_run_results.rc > 2
  when:
    - wildfly_home is defined # repl by not is install

- name: "Ensure that {{ wildfly_home }} belongs to appropriate user - if defined."
  ansible.builtin.file:
    path: "{{ wildfly_home }}"
    recurse: yes
    owner: "{{ wildfly_install_user }}"
    group: "{{ wildfly_install_group | default(wildfly_install_user) }}"
  when:
    - wildfly_install_user is defined
